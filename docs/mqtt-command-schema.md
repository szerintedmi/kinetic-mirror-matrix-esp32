# MQTT Command & Response Schema

This document defines the canonical envelope, status taxonomy, and parameter mappings for commands transported over MQTT. The same error and status catalog is shared with the serial protocol so tooling can reason about results uniformly.

## Envelope

Commands are published to `devices/<node_id>/cmd` with the following JSON structure:

```json
{
  "cmd_id": "<uuid-v4 optional>",
  "action": "MOVE",
  "params": { ... },
  "meta": { ... optional ... }
}
```

- `cmd_id` is optional. When present it must be a UUIDv4 generated by the caller; when omitted the firmware allocates a fresh UUIDv4 via `transport::message_id::Next()` and returns it in all acknowledgements and completions so clients can correlate responses.
- `action` mirrors the serial command action (case-insensitive; processed as upper-case).
- `params` contains action-specific fields described in [Parameter Mapping](#parameter-mapping).
- `meta` is reserved for future extensions (e.g., client hints) and is currently ignored by firmware.

Firmware publishes responses to `devices/<node_id>/cmd/resp` as QoS1 messages:

1. **ACK** – emitted only when the command was accepted for execution.
2. **Completion** – final outcome once execution finishes (success or error).

### ACK Message

```json
{
  "cmd_id": "...",
  "action": "MOVE",
  "status": "ack",
  "result": {
    "est_ms": 1200
  },
  "warnings": [ { "code": "THERMAL_NO_BUDGET", "reason": "..." } ]
}
```

- `ack` only appears when a command is accepted for execution; validation failures skip the ACK and emit only the completion payload below.
- `result` contains context extracted from the serial ACK line (e.g., `est_ms`).
- `warnings` surface non-fatal warnings emitted prior to acknowledgement.

If a request is rejected during validation, the firmware skips the ACK and emits only the completion message below.

### Completion Message

```json
{
  "cmd_id": "...",
  "action": "MOVE",
  "status": "done",
  "result": {
    "actual_ms": 1187
  },
  "warnings": [],
  "errors": []
}
```

`status` values:

| Status   | Meaning                                                      |
|----------|--------------------------------------------------------------|
| `ack`    | Immediate acknowledgement (sent only in ACK payloads).       |
| `done`   | Command completed successfully.                              |
| `error`  | Command was rejected or failed during execution.            |
| `unknown` | Firmware could not classify the outcome (should not occur). |

`errors` contains zero or more entries of the form:

```json
{
  "code": "E03",
  "reason": "BAD_PARAM",
  "message": "Command parameter failed validation; MULTI_CMD_CONFLICT",
  "budget_s": 120
}
```

`warnings` share the same structure (missing `message` when no catalog description exists).

When execution finishes, the firmware reports the total elapsed time via `result.actual_ms`. Per-motor telemetry continues to stream through the STATUS topic, so the completion payload no longer enumerates each motor.

## Error & Warning Catalog

| Code                  | Reason / Message                                                   | Completion Status |
|-----------------------|--------------------------------------------------------------------|-------------------|
| `E01`                 | BAD_CMD – Unknown or unsupported action                              | `error`           |
| `E02`                 | BAD_ID – Target motor ID is invalid                                | `error`           |
| `E03`                 | BAD_PARAM – Command parameter failed validation                    | `error`           |
| `E04`                 | BUSY – Controller is busy executing another command                | `error`           |
| `E07`                 | POS_OUT_OF_RANGE – Target position is outside allowed range        | `error`           |
| `E10`                 | THERMAL_REQ_GT_MAX – Requested move exceeds thermal cap            | `error`           |
| `E11`                 | THERMAL_NO_BUDGET – Insufficient runtime budget                    | `error`           |
| `E12`                 | THERMAL_NO_BUDGET_WAKE – WAKE forbidden by thermal limits          | `error`           |
| `NET_BAD_PARAM`       | Invalid Wi-Fi credential payload                                   | `error`           |
| `NET_SAVE_FAILED`     | Failed to persist Wi-Fi credentials                                | `error`           |
| `NET_SCAN_AP_ONLY`    | Wi-Fi scan allowed only while in SoftAP                            | `error`           |
| `NET_BUSY_CONNECTING` | Wi-Fi subsystem busy connecting                                    | `error`           |
| `NET_CONNECT_FAILED`  | Wi-Fi connection attempt failed                                   | `error`           |
| `MQTT_BAD_PAYLOAD`    | MQTT command payload failed schema validation                      | `error`           |
| `MQTT_UNSUPPORTED_ACTION` | Action is not yet available via MQTT transport                    | `error`           |

Warnings reuse the same codes without changing completion status.

## Parameter Mapping

The `params` object mirrors the serial taxonomy with named keys. All numeric values are expressed in integer steps / milliseconds unless noted.

### MOVE

| Field            | Type                | Description                                 | Serial Mapping                      |
|------------------|---------------------|---------------------------------------------|-------------------------------------|
| `target_ids`     | `"ALL"` \| integer | Target motor or broadcast                    | `MOVE:<id|ALL>,...`                 |
| `position_steps` | integer             | Absolute step target                         | second argument                     |
| `speed_sps`      | integer (optional)  | Override speed in steps/sec                  | third argument                      |
| `accel_sps2`     | integer (optional)  | Override acceleration in steps/sec²         | fourth argument                     |

### HOME

| Field               | Type                | Description                                   | Serial Mapping                                      |
|---------------------|---------------------|-----------------------------------------------|-----------------------------------------------------|
| `target_ids`        | `"ALL"` \| integer | Target motor(s)                               | `HOME:<id|ALL>,...`                                  |
| `overshoot_steps`   | integer (optional)  | Overshoot distance                             | second argument                                     |
| `backoff_steps`     | integer (optional)  | Backoff distance                               | third argument                                      |
| `speed_sps`         | integer (optional)  | Override speed                                 | fourth argument (non shared-step builds)            |
| `accel_sps2`        | integer (optional)  | Override acceleration                          | fifth argument (non shared-step builds)             |
| `full_range_steps`  | integer (optional)  | Custom full-range distance                     | final argument                                      |

### WAKE / SLEEP

| Field        | Type                | Description            | Serial Mapping      |
|--------------|---------------------|------------------------|---------------------|
| `target_ids` | `"ALL"` \| integer | Mask of motors to act on | `WAKE:<id|ALL>` etc |

### STATUS

`params` is empty. Completion payload includes `result.lines` mirroring serial STATUS rows; detailed motor state continues to be published on the STATUS topic.

### GET

| Field     | Type    | Description                                  | Serial Mapping                   |
|-----------|---------|----------------------------------------------|----------------------------------|
| `resource` | string | `"ALL"`, `"SPEED"`, `"ACCEL"`, `"DECEL"`, `"THERMAL_LIMITING"`, `"LAST_OP_TIMING"` [optional `target_ids`] | `GET ...` and `GET LAST_OP_TIMING[:id]` |

### SET

| Field                | Type    | Description                                               | Serial Mapping                |
|----------------------|---------|-----------------------------------------------------------|-------------------------------|
| `thermal_limiting`   | string (`"ON"`/`"OFF"`) | Toggle thermal enforcement                     | `SET THERMAL_LIMITING=...`    |
| `speed_sps`          | integer | Update default speed                                    | `SET SPEED=<value>`           |
| `accel_sps2`         | integer | Update default acceleration                             | `SET ACCEL=<value>`           |
| `decel_sps2`         | integer | Update default deceleration                             | `SET DECEL=<value>`           |

### NET Commands

| Action         | Parameters                                                                 | Serial Mapping                         |
|----------------|----------------------------------------------------------------------------|----------------------------------------|
| `NET:STATUS`   | none                                                                       | `NET:STATUS`                           |
| `NET:RESET`    | none                                                                       | `NET:RESET`                            |
| `NET:LIST`     | none                                                                       | `NET:LIST`                             |
| `NET:SET`      | `ssid` (string), `pass` (string) – values automatically quoted as needed   | `NET:SET,"<ssid>","<pass>"`          |

These actions mirror the serial-based NET interface that ships with Wi‑Fi onboarding; the MQTT transport reuses the same payload grammar, validation rules, and error codes. See the Wi‑Fi onboarding spec for end-to-end behavior.

Additional actions inherit their serial parameters verbatim and will be exercised during subsequent implementation phases (e.g., configuration actions added in Task Group 2).

## Duplicate Handling

Devices maintain a cache of recent `cmd_id` values (including IDs the firmware generates when clients omit them). When a duplicate request is observed (same `cmd_id`), the firmware:

1. Logs `CTRL:INFO MQTT_DUPLICATE cmd_id=<...>` (rate-limited).
2. Replays the previously published ACK (and completion if already sent).
3. Skips command re-execution to ensure idempotency.

## Implementation Notes

- Response parsing and formatting share `transport::command::Response`, ensuring serial and MQTT transports consume the same catalog without altering the serial line format.
- ACK payloads are published only when a command is accepted for execution; validation failures emit a single completion message with status `error`.
- Asynchronous actions (MOVE/HOME) emit a completion payload after motion finishes; the result contains aggregate timing (`actual_ms`), while per-motor state continues to stream via STATUS.
- Errors raised before execution (schema/action issues) use the `MQTT_BAD_PAYLOAD` / `MQTT_UNSUPPORTED_ACTION` codes, yielding a completion status of `error`.
